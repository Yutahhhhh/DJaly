services:
  api:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: djaly-api
    ports:
      - "8001:8001"
    volumes:
      # 1. アプリケーションコード (ホットリロード用)
      - ./backend:/app
      
      # 2. 音楽ファイル (Macのパスをそのまま通す)
      - /Users:/Users:ro
      
      # 3. DBデータの永続化
      - ./db_data:/db_data
      
    environment:
      - OLLAMA_HOST=http://host.docker.internal:11434
      - DB_PATH=/db_data/djaly.duckdb
      # 開発中のリロードは便利な反面、不安定要素になるため今回は無効化推奨
      # (start.sh で制御しているので、ここでの設定は念のため)
      - WATCHFILES_FORCE_POLLING=false
      
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # ヘルスチェック (起動完了を待つため)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s